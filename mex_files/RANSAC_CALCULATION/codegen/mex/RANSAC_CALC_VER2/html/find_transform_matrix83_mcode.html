<pre class="code">
<span class="srcline"><span class="lineno"><a href="40,1"> 1</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,2"> 2</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T33U3">rot</span>, <span class="var type1" id="S3T31U4">trans</span>, <span class="var type1" id="S4T2U5">state</span>] = find_transform_matrix(<span class="var type1" id="S5T30U8">pset1</span>, <span class="var type1" id="S6T30U9">pset2</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="40,3"> 3</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="40,4"> 4</a></span><span class="line"><span class="comment">% This function find rotation matrix (and Euler angles) and translation matrix of two point sets.</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,5"> 5</a></span><span class="line"><span class="comment">% state=0: no solution</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,6"> 6</a></span><span class="line"><span class="comment">% state=1: desired solution found.</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,7"> 7</a></span><span class="line"><span class="comment">% state=2: desired solution found, points are co-planar.</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,8"> 8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="40,9"> 9</a></span><span class="line"><span class="mxinfo" id="T33:U6"><span class="var type1" id="S7T33U12">H</span>=<span class="mxinfo" id="T33:U8">[<span class="mxinfo" id="T32:U9"><span class="mxinfo" id="T2:U10">0</span> <span class="mxinfo" id="T2:U11">0</span> <span class="mxinfo" id="T2:U12">0</span></span>; <span class="mxinfo" id="T32:U13"><span class="mxinfo" id="T2:U14">0</span> <span class="mxinfo" id="T2:U15">0</span> <span class="mxinfo" id="T2:U16">0</span></span>; <span class="mxinfo" id="T32:U17"><span class="mxinfo" id="T2:U18">0</span> <span class="mxinfo" id="T2:U19">0</span> <span class="mxinfo" id="T2:U20">0</span></span>]</span></span>;    </span></span>
<span class="srcline"><span class="lineno"><a href="40,10">10</a></span><span class="line"><span class="mxinfo" id="T19:U21"><span class="var type1" id="S8T19U28">tmp</span>=<span class="mxinfo" id="T19:U23">size(<span class="var type1" id="S6T30U31">pset2</span>)</span></span>;    <span class="mxinfo" id="T2:U25"><span class="var type1" id="S10T2U34">pnum</span>=<span class="mxinfo" id="T2:U27"><span class="var type1" id="S8T19U36">tmp</span>(<span class="mxinfo" id="T2:U29">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,11">11</a></span><span class="line"><span class="mxinfo" id="T31:U30"><span class="var type1" id="S11T31U40">ct1</span> = <span class="mxinfo" id="T31:U32"><span class="mxinfo" id="T31:U33">sum(<span class="var type1" id="S5T30U44">pset1</span>,2)</span>/<span class="var type1" id="S10T2U46">pnum</span></span></span>;  <span class="mxinfo" id="T31:U36"><span class="var type1" id="S13T31U49">ct2</span> = <span class="mxinfo" id="T31:U38"><span class="mxinfo" id="T31:U39">sum(<span class="var type1" id="S6T30U53">pset2</span>,2)</span>/<span class="var type1" id="S10T2U55">pnum</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,12">12</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S14T2U58">i</span>=<span class="mxinfo" id="T2:U43">1</span>:<span class="var type1" id="S10T2U61">pnum</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,13">13</a></span><span class="line">    <span class="mxinfo" id="T31:U45"><span class="var type1" id="S15T31U64">q1</span>=<span class="mxinfo" id="T31:U47"><span class="mxinfo" id="T31:U48"><span class="var type1" id="S5T30U67">pset1</span>(<span class="mxinfo" id="T70:U50">:</span>,<span class="var type1" id="S14T2U69">i</span>)</span>-<span class="var type1" id="S11T31U70">ct1</span></span></span>;    <span class="mxinfo" id="T31:U53"><span class="var type1" id="S16T31U73">q2</span>=<span class="mxinfo" id="T31:U55"><span class="mxinfo" id="T31:U56"><span class="var type1" id="S6T30U76">pset2</span>(<span class="mxinfo" id="T70:U58">:</span>,<span class="var type1" id="S14T2U78">i</span>)</span>-<span class="var type1" id="S13T31U79">ct2</span></span></span>;    <span class="mxinfo" id="T33:U61"><span class="var type1" id="S17T33U82">Q21</span>=<span class="mxinfo" id="T33:U63"><span class="var type1" id="S16T31U84">q2</span>*<span class="mxinfo" id="T32:U65"><span class="var type1" id="S15T31U86">q1</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,14">14</a></span><span class="line">    <span class="mxinfo" id="T33:U67"><span class="var type1" id="S7T33U89">H</span> = <span class="mxinfo" id="T33:U69"><span class="var type1" id="S7T33U91">H</span>+<span class="var type1" id="S17T33U92">Q21</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,15">15</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,16">16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="40,17">17</a></span><span class="line"><span class="mxinfo" id="T33:U72">[<span class="var type1" id="S18T33U96">U</span>, <span class="var type1" id="S19T33U97">S</span>, <span class="var type1" id="S20T33U98">V</span>] = svd(<span class="var type1" id="S7T33U101">H</span>)</span>;         <span class="mxinfo" id="T32:U77"><span class="var type1" id="S22T32U104">sv</span> = <span class="mxinfo" id="T32:U79">[<span class="mxinfo" id="T2:U80">abs(<span class="mxinfo" id="T2:U81"><span class="var type1" id="S19T33U110">S</span>(<span class="mxinfo" id="T2:U83">1</span>,<span class="mxinfo" id="T2:U84">1</span>)</span>)</span>, <span class="mxinfo" id="T2:U85">abs(<span class="mxinfo" id="T2:U86"><span class="var type1" id="S19T33U116">S</span>(<span class="mxinfo" id="T2:U88">2</span>,<span class="mxinfo" id="T2:U89">2</span>)</span>)</span>, <span class="mxinfo" id="T2:U90">abs(<span class="mxinfo" id="T2:U91"><span class="var type1" id="S19T33U122">S</span>(<span class="mxinfo" id="T2:U93">3</span>,<span class="mxinfo" id="T2:U94">3</span>)</span>)</span>]</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="40,18">18</a></span><span class="line"><span class="mxinfo" id="T33:U95"><span class="var type1" id="S24T33U127">Xq</span> = <span class="mxinfo" id="T33:U97"><span class="var type1" id="S20T33U129">V</span> * <span class="mxinfo" id="T33:U99"><span class="var type1" id="S18T33U131">U</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,19">19</a></span><span class="line"><span class="mxinfo" id="T2:U101"><span class="var type1" id="S25T2U134">mdet</span> = <span class="mxinfo" id="T2:U103">det(<span class="var type1" id="S24T33U137">Xq</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,20">20</a></span><span class="line"><span class="mxinfo" id="T2:U105"><span class="var type1" id="S27T2U140">threshold</span> = <span class="mxinfo" id="T2:U107">0.00000000001</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,21">21</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T6:U108"><span class="mxinfo" id="T2:U109">round(<span class="var type1" id="S25T2U147">mdet</span>)</span> == <span class="mxinfo" id="T2:U111">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="40,22">22</a></span><span class="line">    <span class="mxinfo" id="T33:U112"><span class="var type1" id="S2T33U151">rot</span> = <span class="var type1" id="S24T33U152">Xq</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,23">23</a></span><span class="line">    <span class="mxinfo" id="T31:U115"><span class="var type1" id="S3T31U155">trans</span> = <span class="mxinfo" id="T31:U117"><span class="var type1" id="S11T31U157">ct1</span> - <span class="mxinfo" id="T31:U119"><span class="var type1" id="S2T33U159">rot</span>*<span class="var type1" id="S13T31U160">ct2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,24">24</a></span><span class="line">    <span class="mxinfo" id="T2:U122"><span class="var type1" id="S4T2U163">state</span> = <span class="mxinfo" id="T2:U124">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,25">25</a></span><span class="line"><span class="keyword">elseif</span> <span class="mxinfo" id="T6:U125"><span class="mxinfo" id="T2:U126">round(<span class="var type1" id="S25T2U169">mdet</span>)</span> == <span class="mxinfo" id="T2:U128">-<span class="mxinfo" id="T2:U129">1</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="40,26">26</a></span><span class="line">    <span class="mxinfo" id="T16:U130"><span class="var type1" id="S29T16U174">zn</span> = <span class="mxinfo" id="T16:U132">find(<span class="mxinfo" id="T42:U133"><span class="var type1" id="S22T32U178">sv</span>&lt;<span class="var type1" id="S27T2U179">threshold</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,27">27</a></span><span class="line">    <span class="mxinfo" id="T19:U136"><span class="var type1" id="S31T19U182">zs</span> = <span class="mxinfo" id="T19:U138">size(<span class="var type1" id="S29T16U185">zn</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,28">28</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U140"><span class="mxinfo" id="T2:U141"><span class="var type1" id="S31T19U190">zs</span>(<span class="mxinfo" id="T2:U143">2</span>)</span> == <span class="mxinfo" id="T2:U144">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="40,29">29</a></span><span class="line">        <span class="mxinfo" id="T30:U145"><span class="mxinfo" id="T30:U146"><span class="var type1" id="S20T33U196">V</span>(<span class="mxinfo" id="T70:U148">:</span>, <span class="var type1" id="S29T16U198">zn</span>)</span>=<span class="mxinfo" id="T30:U150">-<span class="mxinfo" id="T30:U151"><span class="var type1" id="S20T33U201">V</span>(<span class="mxinfo" id="T70:U153">:</span>, <span class="var type1" id="S29T16U203">zn</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,30">30</a></span><span class="line">        <span class="mxinfo" id="T33:U155"><span class="var type1" id="S2T33U206">rot</span> = <span class="mxinfo" id="T33:U157"><span class="var type1" id="S20T33U208">V</span> * <span class="mxinfo" id="T33:U159"><span class="var type1" id="S18T33U210">U</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,31">31</a></span><span class="line">        <span class="mxinfo" id="T31:U161"><span class="var type1" id="S3T31U213">trans</span> = <span class="mxinfo" id="T31:U163"><span class="var type1" id="S11T31U215">ct1</span> - <span class="mxinfo" id="T31:U165"><span class="var type1" id="S2T33U217">rot</span>*<span class="var type1" id="S13T31U218">ct2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,32">32</a></span><span class="line">        <span class="mxinfo" id="T2:U168"><span class="var type1" id="S4T2U221">state</span> = <span class="mxinfo" id="T2:U170">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,33">33</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,34">34</a></span><span class="line">        <span class="mxinfo" id="T2:U171"><span class="var type1" id="S4T2U226">state</span> = <span class="mxinfo" id="T2:U173">-<span class="mxinfo" id="T2:U174">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,35">35</a></span><span class="line">        <span class="mxinfo" id="T33:U175"><span class="var type1" id="S2T33U231">rot</span>=<span class="var type1" id="S7T33U232">H</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,36">36</a></span><span class="line">        <span class="mxinfo" id="T31:U178"><span class="var type1" id="S3T31U235">trans</span>=<span class="mxinfo" id="T31:U180"><span class="mxinfo" id="T32:U181">[<span class="mxinfo" id="T2:U182">0</span> <span class="mxinfo" id="T2:U183">0</span> <span class="mxinfo" id="T2:U184">0</span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,37">37</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,38">38</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="40,39">39</a></span><span class="line">    <span class="mxinfo" id="T2:U185"><span class="var type1" id="S4T2U245">state</span> = <span class="mxinfo" id="T2:U187">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,40">40</a></span><span class="line">    <span class="mxinfo" id="T33:U188"><span class="var type1" id="S2T33U249">rot</span>=<span class="var type1" id="S7T33U250">H</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,41">41</a></span><span class="line">    <span class="mxinfo" id="T31:U191"><span class="var type1" id="S3T31U253">trans</span>=<span class="mxinfo" id="T31:U193"><span class="mxinfo" id="T32:U194">[<span class="mxinfo" id="T2:U195">0</span> <span class="mxinfo" id="T2:U196">0</span> <span class="mxinfo" id="T2:U197">0</span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="40,42">42</a></span><span class="line"><span class="keyword"><span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="40,43">43</a></span><span class="line"></span></span>
</pre>
